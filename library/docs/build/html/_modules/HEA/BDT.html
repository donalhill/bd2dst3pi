

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>HEA.BDT &mdash; HEA 0.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../HEA.config.html">HEA.config package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../HEA.fit.html">HEA.fit package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../HEA.plot.html">HEA.plot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../HEA.tools.html">HEA.tools package</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">HEA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>HEA.BDT</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for HEA.BDT</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module for BDT:</span>

<span class="sd">* Plot the distributions of the chosen variables in signal and background (super-imposed)</span>
<span class="sd">* Prepare the signal and background sample (merge them, create a &#39;y&#39; variable for learning, ...)</span>
<span class="sd">* Train the BDT with the specified classifier (adaboost or gradientboosting)</span>
<span class="sd">* Plot the result of the tests (ROC curve, overtraining check with KS test)</span>
<span class="sd">* Apply the BDT to the data and save the result</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">from</span> <span class="nn">HEA.config</span> <span class="kn">import</span> <span class="n">loc</span>

<span class="kn">import</span> <span class="nn">HEA.plot.tools</span> <span class="k">as</span> <span class="nn">pt</span>
<span class="kn">import</span> <span class="nn">HEA.plot.histogram</span> <span class="k">as</span> <span class="nn">h</span>
<span class="kn">from</span> <span class="nn">HEA.tools.dir</span> <span class="kn">import</span> <span class="n">create_directory</span>
<span class="kn">from</span> <span class="nn">HEA.tools</span> <span class="kn">import</span> <span class="n">string</span>

<span class="kn">from</span> <span class="nn">HEA.tools.da</span> <span class="kn">import</span> <span class="n">add_in_dic</span><span class="p">,</span> <span class="n">show_dictionnary</span>
<span class="kn">from</span> <span class="nn">HEA.tools.serial</span> <span class="kn">import</span> <span class="n">dump_pickle</span>
<span class="kn">from</span> <span class="nn">HEA.pandas_root</span> <span class="kn">import</span> <span class="n">save_root</span>

<span class="kn">from</span> <span class="nn">HEA.definition</span> <span class="kn">import</span> <span class="n">RVariable</span>


<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">makedirs</span>

<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pandas.core.common</span> <span class="k">as</span> <span class="nn">com</span>
<span class="kn">from</span> <span class="nn">pandas.plotting</span> <span class="kn">import</span> <span class="n">scatter_matrix</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">Index</span>

<span class="c1"># sklearn</span>
<span class="kn">from</span> <span class="nn">sklearn.utils.class_weight</span> <span class="kn">import</span> <span class="n">compute_sample_weight</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">AdaBoostClassifier</span><span class="p">,</span> <span class="n">GradientBoostingClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">ks_2samp</span>
 

<span class="c1"># Parameters of the plot</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rcParams</span><span class="p">,</span> <span class="n">use</span>
<span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span><span class="o">**</span><span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span><span class="s1">&#39;serif&#39;</span><span class="p">,</span><span class="s1">&#39;serif&#39;</span><span class="p">:[</span><span class="s1">&#39;Roman&#39;</span><span class="p">]})</span>
<span class="n">rc</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1">#use(&#39;Agg&#39;) #no plot.show() --&gt; no display needed</span>

<span class="c1">#################################################################################################</span>
<span class="c1">###################################### Plotting function ########################################</span>
<span class="c1">################################################################################################# </span>


<span class="c1"># it&#39;s an adaptation of hist_frame of  pandas.plotting._core</span>
<div class="viewcode-block" id="signal_background"><a class="viewcode-back" href="../../index.html#HEA.BDT.signal_background">[docs]</a><span class="k">def</span> <span class="nf">signal_background</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">range_column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">xlabelsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabelsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">layout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">fig_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">folder_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw histogram of the DataFrame&#39;s series comparing the distribution</span>
<span class="sd">    in ``data1`` to ``data2`` and save the result in </span>
<span class="sd">    ``{loc[&#39;plot&#39;]}/BDT/{folder_name}/1D_hist_{fig_name}``</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data1        : pandas.Dataframe</span>
<span class="sd">        First dataset</span>
<span class="sd">    data2        : pandas.Dataframe</span>
<span class="sd">        Second dataset</span>
<span class="sd">    column       : str or list(str)</span>
<span class="sd">        If passed, will be used to limit data to a subset of columns</span>
<span class="sd">    grid         : bool</span>
<span class="sd">        Whether to show axis grid lines</span>
<span class="sd">    xlabelsize   : int</span>
<span class="sd">        if specified changes the x-axis label size</span>
<span class="sd">    ylabelsize   : int</span>
<span class="sd">        if specified changes the y-axis label size</span>
<span class="sd">    ax           : matplotlib.axes.Axes</span>
<span class="sd">    sharex       : bool</span>
<span class="sd">        if True, the X axis will be shared amongst all subplots.</span>
<span class="sd">    sharey       : bool</span>
<span class="sd">        if True, the Y axis will be shared amongst all subplots.</span>
<span class="sd">    figsize      : tuple</span>
<span class="sd">        the size of the figure to create in inches by default</span>
<span class="sd">    bins         : int,</span>
<span class="sd">        number of histogram bins to be used</span>
<span class="sd">    fig_name    : str</span>
<span class="sd">        name of the saved file</span>
<span class="sd">    folder_name  : str</span>
<span class="sd">        name of the folder where to save the plot</span>
<span class="sd">    colors       : [str, str]</span>
<span class="sd">        colors used for the two datasets</span>
<span class="sd">    **kwds       : dict</span>
<span class="sd">        other plotting keyword arguments, to be passed to the `ax.hist()` function</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig : matplotlib.figure.Figure</span>
<span class="sd">        Figure of the plot </span>
<span class="sd">    ax : matplotlib.figure.Axes</span>
<span class="sd">        Axis of the plot </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;alpha&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
        <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>

    
    <span class="k">if</span> <span class="n">column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># column is not a list, convert it into a list.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Index</span><span class="p">)):</span>
            <span class="n">column</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span><span class="p">]</span>
        <span class="n">data1</span> <span class="o">=</span> <span class="n">data1</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
        <span class="n">data2</span> <span class="o">=</span> <span class="n">data2</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
        
    <span class="n">data1</span> <span class="o">=</span> <span class="n">data1</span><span class="o">.</span><span class="n">_get_numeric_data</span><span class="p">()</span> <span class="c1"># select only numbers</span>
    <span class="n">data2</span> <span class="o">=</span> <span class="n">data2</span><span class="o">.</span><span class="n">_get_numeric_data</span><span class="p">()</span> <span class="c1"># seject only numbers</span>
    <span class="n">naxes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="c1"># number of axes = number of available columns</span>
    
    <span class="n">max_nrows</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="c1"># subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">naxes</span><span class="p">,</span><span class="n">max_nrows</span><span class="p">),</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="n">naxes</span><span class="o">//</span><span class="n">max_nrows</span> <span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">sharex</span><span class="o">=</span><span class="n">sharex</span><span class="p">,</span>
                                   <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span>
                                   <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    
    <span class="n">_axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span>

    <span class="k">if</span> <span class="n">range_column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">range_column</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">column</span><span class="p">))]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span> <span class="c1"># data.columns = the column labels of the DataFrame.</span>
        <span class="c1"># col = name of the column/variable</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">_axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">range_column</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">range_column</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">range_column</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">data2</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">low</span> <span class="o">=</span> <span class="n">range_column</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">range_column</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">data2</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">high</span> <span class="o">=</span> <span class="n">range_column</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">redefine_low_high</span><span class="p">(</span><span class="n">range_column</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">range_column</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">data1</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">data2</span><span class="p">[</span><span class="n">col</span><span class="p">]])</span> 
        <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">plot_hist_alone</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data1</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mode_hist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                        <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;background&#39;</span><span class="p">,</span> <span class="n">label_ncounts</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">plot_hist_alone</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data2</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mode_hist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                        <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="n">label_ncounts</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        
        <span class="n">bin_width</span><span class="o">=</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span><span class="o">/</span><span class="n">n_bins</span>
        <span class="n">latex_branch</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">RVariable</span><span class="o">.</span><span class="n">get_latex_branch_unit_from_branch</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">set_label_hist</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">latex_branch</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">bin_width</span><span class="o">=</span><span class="n">bin_width</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">fix_plot</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">factor_ymax</span><span class="o">=</span><span class="mi">1</span><span class="o">+</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">show_leg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize_ticks</span><span class="o">=</span><span class="mf">15.</span><span class="p">,</span> <span class="n">fontsize_leg</span><span class="o">=</span><span class="mf">20.</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">show_grid</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">)</span>
                 
    <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">_axes</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">_axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="c1">#fig.subplots_adjust(wspace=0.3, hspace=0.7)</span>
    <span class="k">if</span> <span class="n">fig_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig_name</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">list_into_string</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">save_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;1D_hist_</span><span class="si">{</span><span class="n">fig_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">folder_name</span><span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;BDT/</span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span></div>

<div class="viewcode-block" id="correlations"><a class="viewcode-back" href="../../index.html#HEA.BDT.correlations">[docs]</a><span class="k">def</span> <span class="nf">correlations</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fig_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">folder_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculate pairwise correlation between features of the dataframe data </span>
<span class="sd">    and save the figure in ``{loc[&#39;plot&#39;]}/BDT/{folder_name}/corr_matrix_{fig_name}``</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data         : pandas.Dataframe</span>
<span class="sd">        dataset</span>
<span class="sd">    fig_name     : str</span>
<span class="sd">        name of the saved file</span>
<span class="sd">    folder_name  : str</span>
<span class="sd">        name of the folder where to save the plot</span>
<span class="sd">    **kwds       : dict</span>
<span class="sd">        other plotting keyword arguments, to be passed to ``pandas.DataFrame.corr()``</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig : matplotlib.figure.Figure</span>
<span class="sd">        Figure of the plot </span>
<span class="sd">    ax : matplotlib.figure.Axes</span>
<span class="sd">        Axis of the plot </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># simply call df.corr() to get a table of</span>
    <span class="c1"># correlation values if you do not need</span>
    <span class="c1"># the fancy plotting</span>
    <span class="n">corrmat</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">)</span> <span class="c1"># correlation</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span> <span class="c1"># 1 plot</span>
    
    <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cmap&#39;</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;RdBu&quot;</span><span class="p">),</span> <span class="c1"># red blue color mode</span>
            <span class="s1">&#39;vmin&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;vmax&#39;</span><span class="p">:</span> <span class="o">+</span><span class="mi">1</span><span class="p">}</span> <span class="c1"># correlation between -1 and 1</span>
    <span class="n">heatmap1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">pcolor</span><span class="p">(</span><span class="n">corrmat</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span> <span class="c1"># create a pseudo color plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">heatmap1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span> <span class="c1"># color bar</span>

    <span class="n">title</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s2">&quot;Correlations&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="s1">&#39; - &#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">corrmat</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="c1"># get the list of labels</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="n">latex_branch</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">RVariable</span><span class="o">.</span><span class="n">get_latex_branch_unit_from_branch</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">latex_branch</span>
    <span class="c1"># shift location of ticks to center of the bins</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">70</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    
    <span class="k">if</span> <span class="n">fig_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig_name</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">list_into_string</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
        
    <span class="n">pt</span><span class="o">.</span><span class="n">save_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;corr_matrix_</span><span class="si">{</span><span class="n">fig_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">folder_name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;BDT/</span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span></div>
    

<span class="c1">#################################################################################################</span>
<span class="c1">######################################## BDT training ###########################################</span>
<span class="c1">################################################################################################# </span>

<span class="c1">## DATA PROCESSING ------------------------------------------------------</span>

    
<div class="viewcode-block" id="concatenate"><a class="viewcode-back" href="../../index.html#HEA.BDT.concatenate">[docs]</a><span class="k">def</span> <span class="nf">concatenate</span><span class="p">(</span><span class="n">dfa_tot_sig</span><span class="p">,</span> <span class="n">dfa_tot_bkg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Concatenate the signal and background dataframes </span>
<span class="sd">    and create a new variable ``y``, </span>
<span class="sd">    which is 1 if the candidate is signal,</span>
<span class="sd">    or 0 if it is background.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dfa_tot_sig : pandas.Dataframe</span>
<span class="sd">        Signal dataframe</span>
<span class="sd">    dfa_tot_bkg : pandas.Dataframe</span>
<span class="sd">        Background dataframe    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    X  : numpy.ndarray </span>
<span class="sd">        Array with signal and MC data concatenated</span>
<span class="sd">    y  : numpy.array</span>
<span class="sd">        new variable: array with 1 for the signal events, and 0 for background events</span>
<span class="sd">    df : pandas.Dataframe </span>
<span class="sd">        signal and background dataframes concatenated with with the new column ``&#39;y&#39;``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfa_tot_sig</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfa_tot_bkg</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">dfa_tot_sig</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="n">dfa_tot_bkg</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    
    <span class="c1"># Concatenated data</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">dfa_tot_sig</span><span class="p">,</span> <span class="n">dfa_tot_bkg</span><span class="p">))</span>
    <span class="c1"># List of 1 for signal and 0 for background (mask)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">dfa_tot_sig</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dfa_tot_bkg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>

    <span class="c1"># Concatened dataframe of signal + background, with a new variable y:</span>
    <span class="c1"># y = 0 if background</span>
    <span class="c1"># y = 1 if signal</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))),</span>
                      <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">dfa_tot_sig</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">df</span></div>

<div class="viewcode-block" id="bg_sig"><a class="viewcode-back" href="../../index.html#HEA.BDT.bg_sig">[docs]</a><span class="k">def</span> <span class="nf">bg_sig</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the mask to get the background and the signal (in this order)</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y  : numpy.array</span>
<span class="sd">        array with 1 for the signal events, and 0 for background events</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    signal: numpy.array</span>
<span class="sd">        array with ``True`` if signal event, else ``False``</span>
<span class="sd">    background: numpy.array</span>
<span class="sd">        array with ``True`` if background event, else ``False``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">y</span><span class="o">&lt;</span><span class="mf">0.5</span><span class="p">),(</span><span class="n">y</span><span class="o">&gt;</span><span class="mf">0.5</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_train_test"><a class="viewcode-back" href="../../index.html#HEA.BDT.get_train_test">[docs]</a><span class="k">def</span> <span class="nf">get_train_test</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get the train and test arrays</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X  : numpy.ndarray </span>
<span class="sd">        Array with signal and MC data concatenated</span>
<span class="sd">    y  : numpy.array</span>
<span class="sd">        Array with 1 for the signal events, and 0 for background events</span>
<span class="sd">    test_size: float between 0 and 1</span>
<span class="sd">        size of the test sample relatively to the full datasample</span>
<span class="sd">    random_state: float</span>
<span class="sd">        random state</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    X_train : numpy.ndarray</span>
<span class="sd">        Array with signal and MC data concatenated and shuffled for training</span>
<span class="sd">    X_text  : numpy.ndarray</span>
<span class="sd">        Array with signal and MC data concatenated and shuffled for test</span>
<span class="sd">    y_train : numpy.array</span>
<span class="sd">        Array with 1 for the signal events, and 0 for background events (shuffled) for training</span>
<span class="sd">    y_test  : numpy.array</span>
<span class="sd">        Array with 1 for the signal events, and 0 for background events (shuffled) for test</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Separate train/test data</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span></div>

<div class="viewcode-block" id="get_train_test_df"><a class="viewcode-back" href="../../index.html#HEA.BDT.get_train_test_df">[docs]</a><span class="k">def</span> <span class="nf">get_train_test_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get the train and test pandas dataframes</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.Dataframe</span>
<span class="sd">        dataframe</span>
<span class="sd">    test_size: float between 0 and 1</span>
<span class="sd">        size of the test sample relatively to the full datasample</span>
<span class="sd">    random_state: float</span>
<span class="sd">        random state</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df_train : pandas.Dataframe</span>
<span class="sd">        dataframe using for training</span>
<span class="sd">    df_test : pandas.Dataframe</span>
<span class="sd">        dataframe using for test</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Separate train/test data</span>
    <span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span></div>


<div class="viewcode-block" id="BDT"><a class="viewcode-back" href="../../index.html#HEA.BDT.BDT">[docs]</a><span class="k">def</span> <span class="nf">BDT</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">classifier</span><span class="o">=</span><span class="s1">&#39;adaboost&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">hyperparams</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Train the BDT and return the result</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X               : numpy ndarray</span>
<span class="sd">        array with signal and background concatenated,</span>
<span class="sd">        The columns of X correspond to the variable the BDT will be trained with</span>
<span class="sd">    y               : numpy array</span>
<span class="sd">        array with 1 if the concatened event is signal, 0 if it is background</span>
<span class="sd">    classifier      : str </span>
<span class="sd">        Used classifier</span>
<span class="sd">        </span>
<span class="sd">        * ``&#39;adaboost&#39;``</span>
<span class="sd">        * ``&#39;gradientboosting&#39;``</span>
<span class="sd">        * ``&#39;xgboost&#39;`` (experimental)</span>
<span class="sd">    hyperparameters : dict</span>
<span class="sd">        used hyperparameters.</span>
<span class="sd">        Default:</span>
<span class="sd">        </span>
<span class="sd">        * ``n_estimators = 800``</span>
<span class="sd">        * ``learning_rate = 0.1``</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xgb.XGBClassifier</span>
<span class="sd">        trained XGboost classifier, if ``classifier == &#39;xgboost&#39;``</span>
<span class="sd">    sklearn.ensemble.AdaBoostClassifier</span>
<span class="sd">        trained adaboost classifier, if ``classifier == &#39;adaboost&#39;``</span>
<span class="sd">    sklearn.ensemble.GradientBoostingClassifier</span>
<span class="sd">        trained gradient boosting classifier, if ``classifier == &#39;gradientboosting&#39;``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    
    <span class="n">weights</span> <span class="o">=</span> <span class="n">compute_sample_weight</span><span class="p">(</span><span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">hyperparams</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hyperparams</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="n">add_in_dic</span><span class="p">(</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">,</span> <span class="n">hyperparams</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span>
    <span class="n">add_in_dic</span><span class="p">(</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="n">hyperparams</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="c1"># Learning rate shrinks the contribution of each tree by alpha    </span>
    <span class="n">show_dictionnary</span><span class="p">(</span><span class="n">hyperparams</span><span class="p">,</span> <span class="s2">&quot;hyperparameters&quot;</span><span class="p">)</span>
            
    
    <span class="c1"># Define the BDT</span>
    <span class="k">if</span> <span class="n">classifier</span> <span class="o">==</span> <span class="s1">&#39;adaboost&#39;</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="c1"># The minimum number of samples required to be at a leaf node</span>
        <span class="c1"># here, since it&#39;s a float, it is expressed in fraction of len(X_train)</span>
        <span class="c1"># We need min_samples_leaf samples before deciding to create a new leaf</span>
        <span class="n">bdt</span> <span class="o">=</span> <span class="n">AdaBoostClassifier</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;SAMME&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">hyperparams</span><span class="p">)</span>
        
    <span class="k">elif</span> <span class="n">classifier</span> <span class="o">==</span> <span class="s1">&#39;gradientboosting&#39;</span><span class="p">:</span>
        <span class="n">bdt</span> <span class="o">=</span> <span class="n">GradientBoostingClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="o">**</span><span class="n">hyperparams</span><span class="p">)</span>
    
    <span class="k">elif</span> <span class="n">classifier</span> <span class="o">==</span> <span class="s1">&#39;xgboost&#39;</span><span class="p">:</span> <span class="c1"># experimental</span>
        <span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>
        <span class="n">bdt</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span><span class="n">objective</span><span class="o">=</span><span class="s2">&quot;binary:logistic&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        
        
    <span class="c1">## Learning (fit)</span>
    <span class="n">bdt</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">bdt</span></div>

<span class="c1">#################################################################################################</span>
<span class="c1">################################### Analysis BDT training #######################################</span>
<span class="c1">################################################################################################# </span>

<div class="viewcode-block" id="classification_report_print"><a class="viewcode-back" href="../../index.html#HEA.BDT.classification_report_print">[docs]</a><span class="k">def</span> <span class="nf">classification_report_print</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">bdt</span><span class="p">,</span> <span class="n">BDT_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Test the bdt training with the testing sample.\</span>
<span class="sd">    Print and save the report in ``{loc[&#39;tables&#39;]}/BDT/{BDT_name}/classification_report.txt``.</span>
<span class="sd">   </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X_text    : numpy.ndarray</span>
<span class="sd">        Array with signal and MC data concatenated and shuffled for test</span>
<span class="sd">    y_test    : numpy.array</span>
<span class="sd">        Array with 1 for the signal events, and 0 for background events (shuffled) for test</span>
<span class="sd">    bdt       : sklearn.ensemble.AdaBoostClassifier or sklearn.ensemble.GradientBoostingClassifier</span>
<span class="sd">        trained classifier</span>
<span class="sd">    BDT_name      : str</span>
<span class="sd">        name of the BDT, used for the path of the saved txt file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#     if xgboost:</span>
<span class="c1">#         y_predicted = xgbmodel.predict_proba(X)[:,1]</span>
<span class="c1">#     else:    </span>
    <span class="n">y_predicted</span> <span class="o">=</span> <span class="n">bdt</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    
    <span class="n">classification_report_str</span> <span class="o">=</span> <span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_predicted</span><span class="p">,</span>
                                <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;background&quot;</span><span class="p">,</span> <span class="s2">&quot;signal&quot;</span><span class="p">])</span>
    
    
    <span class="nb">print</span><span class="p">(</span><span class="n">classification_report_str</span><span class="p">)</span>
    <span class="n">ROC_AUC_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="c1"># real</span>
                                    <span class="n">bdt</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">X_test</span><span class="p">))</span> 
    <span class="c1"># bdt.decision_function(X_test) = scores = returns a Numpy array, in which each element </span>
    <span class="c1"># represents whether a predicted sample for x_test by the classifier lies to the right </span>
    <span class="c1"># or left side of the Hyperplane and also how far from the HyperPlane.</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Area under ROC curve: </span><span class="si">%.4f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ROC_AUC_score</span><span class="p">))</span>

    <span class="c1">## Write the results -----</span>
    <span class="n">fig_name</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s1">&#39;classification_report&#39;</span><span class="p">,</span> <span class="n">BDT_name</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
    
    <span class="n">path</span> <span class="o">=</span> <span class="n">create_directory</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/BDT/&quot;</span><span class="p">,</span> <span class="n">BDT_name</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">fig_name</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">classification_report_str</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Area under ROC curve: </span><span class="si">%.4f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ROC_AUC_score</span><span class="p">))</span></div>

        

<div class="viewcode-block" id="plot_roc"><a class="viewcode-back" href="../../index.html#HEA.BDT.plot_roc">[docs]</a><span class="k">def</span> <span class="nf">plot_roc</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">bdt</span><span class="p">,</span> <span class="n">BDT_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot and save the roc curve in ``{loc[&#39;plots&#39;]}/BDT/{BDT_name}/ROC.pdf``</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X_test        : numpy.ndarray</span>
<span class="sd">        signal and background concatenated, testing sample</span>
<span class="sd">    y_test        : numpy.array</span>
<span class="sd">        signal and background concatenated, testing sample,</span>
<span class="sd">        0 if the events is background, 1 if it is signal</span>
<span class="sd">    bdt           : sklearn.ensemble.AdaBoostClassifier or sklearn.ensemble.GradientBoostingClassifier</span>
<span class="sd">        trained BDT</span>
<span class="sd">    BDT_name      : str</span>
<span class="sd">        name of the BDT, used for the name of the saved plot</span>
<span class="sd">    folder_name   : str</span>
<span class="sd">        name of the folder where to save the BDT</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig : matplotlib.figure.Figure</span>
<span class="sd">        Figure of the plot </span>
<span class="sd">    ax : matplotlib.figure.Axes</span>
<span class="sd">        Axis of the plot </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1">## Get the results -----</span>
    <span class="n">decisions</span> <span class="o">=</span> <span class="n">bdt</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span> <span class="c1"># result of the BDT of the test sample</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">thresholds</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">decisions</span><span class="p">)</span> <span class="c1"># roc_curve</span>
    <span class="c1"># y_test: true results</span>
    <span class="c1"># decisions: result found by the BDT</span>
    <span class="c1"># fpr: Increasing false positive rates such that element i is the false positive rate of predictions with score &gt;= thresholds[i].</span>
    <span class="c1"># tpr: Increasing true positive rates such that element i is the true positive rate of predictions with score &gt;= thresholds[i].</span>
    <span class="c1"># thresholds: Decreasing thresholds on the decision function used to compute fpr and tpr. thresholds[0] represents no instances being predicted and is arbitrarily set to max(y_score) + 1</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>

    <span class="c1">## Plot the results -----</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ROC (area = </span><span class="si">%0.2f</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">roc_auc</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Luck&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;False Positive Rate&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;True Positive Rate&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Receiver operating characteristic&#39;</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mf">20.</span><span class="p">)</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">show_grid</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">fix_plot</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">factor_ymax</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">show_leg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize_ticks</span><span class="o">=</span><span class="mf">20.</span><span class="p">,</span> <span class="n">ymin_to_0</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1">## Save the results -----</span>
    
    <span class="n">pt</span><span class="o">.</span><span class="n">save_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="s2">&quot;ROC&quot;</span><span class="p">,</span> <span class="n">folder_name</span><span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;BDT/</span><span class="si">{</span><span class="n">BDT_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="compare_train_test"><a class="viewcode-back" href="../../index.html#HEA.BDT.compare_train_test">[docs]</a><span class="k">def</span> <span class="nf">compare_train_test</span><span class="p">(</span><span class="n">bdt</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">BDT_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                      <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot; Plot and save the overtraining plot in ``{loc[&#39;plots&#39;]}/BDT/{folder_name}/overtraining_{BDT_name}.pdf``</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bdt           : sklearn.ensemble.AdaBoostClassifier or sklearn.ensemble.GradientBoostingClassifier</span>
<span class="sd">        trained BDT classifier</span>
<span class="sd">    X_train : numpy.ndarray</span>
<span class="sd">        Array with signal and MC data concatenated and shuffled for training</span>
<span class="sd">    y_train : numpy.array</span>
<span class="sd">        Array with 1 for the signal events, and 0 for background events (shuffled) for training</span>
<span class="sd">    X_text  : numpy.ndarray</span>
<span class="sd">        Array with signal and MC data concatenated and shuffled for test</span>
<span class="sd">    y_test  : numpy.array</span>
<span class="sd">        Array with 1 for the signal events, and 0 for background events (shuffled) for test</span>
<span class="sd">    bins          : int</span>
<span class="sd">        number of bins of the plotted histograms                   </span>
<span class="sd">    BDT_name      : str</span>
<span class="sd">        name of the BDT, used for the folder where the figure is saved</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig              : matplotlib.figure.Figure</span>
<span class="sd">        Figure of the plot </span>
<span class="sd">    ax               : matplotlib.figure.Axes</span>
<span class="sd">        Axis of the plot </span>
<span class="sd">    s_2samp_sig      : float</span>
<span class="sd">        Kolmogorov-Smirnov statistic for the signal distributions</span>
<span class="sd">    ks_2samp_bkg     : float</span>
<span class="sd">        Kolmogorov-Smirnov statistic for the background distributions</span>
<span class="sd">    pvalue_2samp_sig : float</span>
<span class="sd">        p-value of the Kolmogorov-Smirnov test for the signal distributions</span>
<span class="sd">    pvalue_2samp_bkg : float</span>
<span class="sd">        p-value of the Kolmogorov-Smirnov test for the background distributions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
    
    <span class="c1">## decisions = [d(X_train_signal), d(X_train_background),d(X_test_signal), d(X_test_background)]</span>
    <span class="n">decisions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">X</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="p">((</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)):</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">bdt</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">y</span><span class="o">&gt;</span><span class="mf">0.5</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">bdt</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">y</span><span class="o">&lt;</span><span class="mf">0.5</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">decisions</span> <span class="o">+=</span> <span class="p">[</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">]</span> <span class="c1"># [signal, background]</span>
    
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    decisions[0]: train, background</span>
<span class="sd">    decisions[1]: train, signal</span>
<span class="sd">    decisions[2]: test, background</span>
<span class="sd">    decisions[3]: test, signal</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1">## Range of the full plot</span>
    <span class="n">low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">decisions</span><span class="p">)</span>
    <span class="n">high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">decisions</span><span class="p">)</span>
    <span class="n">low_high</span> <span class="o">=</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span><span class="n">high</span><span class="p">)</span>
    
    
    <span class="c1">## Plot for the train data the stepfilled histogram of background (y&lt;0.5) and signal (y&gt;0.5) </span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">decisions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
             <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">low_high</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
             <span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;stepfilled&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;S (train)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">decisions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
             <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">low_high</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
             <span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;stepfilled&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;B (train)&#39;</span><span class="p">)</span>

    <span class="c1">## Plot for the test data the points with uncertainty of background (y&lt;0.5) and signal (y&gt;0.5) </span>
    <span class="n">hist</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">decisions</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                              <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">low_high</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">decisions</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
    <span class="c1"># Compute and rescale the error</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">hist</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span>
    
    <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;S (test)&#39;</span><span class="p">)</span>
    
    <span class="n">hist</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">decisions</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                              <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">low_high</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Compute and rescale the error</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">decisions</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">hist</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;B (test)&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;BDT output&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mf">25.</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Arbitrary units&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mf">25.</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mf">20.</span><span class="p">)</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">show_grid</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    
    <span class="n">pt</span><span class="o">.</span><span class="n">fix_plot</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">factor_ymax</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">show_leg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize_ticks</span><span class="o">=</span><span class="mf">20.</span><span class="p">,</span> <span class="n">ymin_to_0</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    
    <span class="n">pt</span><span class="o">.</span><span class="n">save_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="s2">&quot;overtraining&quot;</span><span class="p">,</span> <span class="n">folder_name</span><span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;BDT/</span><span class="si">{</span><span class="n">BDT_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="n">ks_2samp_sig</span> <span class="o">=</span> <span class="n">ks_2samp</span><span class="p">(</span><span class="n">decisions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">decisions</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">statistic</span>
    <span class="n">ks_2samp_bkg</span> <span class="o">=</span> <span class="n">ks_2samp</span><span class="p">(</span><span class="n">decisions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">decisions</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">statistic</span>
    <span class="n">pvalue_2samp_sig</span> <span class="o">=</span> <span class="n">ks_2samp</span><span class="p">(</span><span class="n">decisions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">decisions</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">pvalue</span>
    <span class="n">pvalue_2samp_bkg</span> <span class="o">=</span> <span class="n">ks_2samp</span><span class="p">(</span><span class="n">decisions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">decisions</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">pvalue</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Kolmogorov-Smirnov statistic&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;signal    : </span><span class="si">{</span><span class="n">ks_2samp_sig</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Background: </span><span class="si">{</span><span class="n">ks_2samp_bkg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;p-value&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;signal    : </span><span class="si">{</span><span class="n">pvalue_2samp_sig</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Background: </span><span class="si">{</span><span class="n">pvalue_2samp_bkg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ks_2samp_sig</span><span class="p">,</span> <span class="n">ks_2samp_bkg</span><span class="p">,</span> <span class="n">pvalue_2samp_sig</span><span class="p">,</span> <span class="n">pvalue_2samp_bkg</span></div>

<div class="viewcode-block" id="apply_BDT"><a class="viewcode-back" href="../../index.html#HEA.BDT.apply_BDT">[docs]</a><span class="k">def</span> <span class="nf">apply_BDT</span><span class="p">(</span><span class="n">df_tot</span><span class="p">,</span> <span class="n">df_train</span><span class="p">,</span> <span class="n">bdt</span><span class="p">,</span> <span class="n">BDT_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_BDT</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">kind_data</span><span class="o">=</span><span class="s1">&#39;common&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    * Apply the BDT to the dataframe ``df_train`` which contains only the training variable.</span>
<span class="sd">    * Add the BDT output as a new variable in ``df_tot``.</span>
<span class="sd">    * Save ``df_tot`` in a root file ``{loc[&#39;root&#39;]}/{kind_data}_{ BDT_name}.root`` (branch ``&#39;DecayTree&#39;``)</span>
<span class="sd">    * In addition,  save the BDT output in a separated root file ``{loc[&#39;root&#39;]t/BDT_{BDT_name}.root`` (branch ``&#39;BDT&#39;``)</span>
<span class="sd">    * if ``save_BDT`` is ``True``, save the BDT in a root file ``{loc[&#39;pickle&#39;]}/bdt_{BDT_name}.pickle``</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_tot        : pandas.Dataframe </span>
<span class="sd">        dataframe that will be saved together with the BDT output</span>
<span class="sd">    df_train      : pandas.Dataframe </span>
<span class="sd">        dataframe with only the variables that have been used for the training </span>
<span class="sd">    bdt           : sklearn.ensemble.AdaBoostClassifier or sklearn.ensemble.GradientBoostingClassifier</span>
<span class="sd">        trained BDT classifier</span>
<span class="sd">    BDT_name      : str</span>
<span class="sd">        name of the BDT, used for the name of the saved files</span>
<span class="sd">    save_BDT      : bool</span>
<span class="sd">        if True, save the BDT in a pickle file</span>
<span class="sd">    kind_data     : str</span>
<span class="sd">        name of the data where the BDT is applied to (e.g., ``&#39;MC&#39;``, ``&#39;common&#39;``, ...)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Apply the BDT to the dataframe that contains only the variables used in the training, in the right order</span>
    <span class="n">df_tot</span><span class="p">[</span><span class="s1">&#39;BDT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bdt</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span>

    <span class="n">file_name</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">kind_data</span><span class="p">,</span> <span class="n">BDT_name</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BDT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_tot</span><span class="p">[</span><span class="s1">&#39;BDT&#39;</span><span class="p">]</span>
    
    <span class="n">save_root</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;BDT_&#39;</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;DecayTree&#39;</span><span class="p">)</span>
    <span class="n">save_root</span><span class="p">(</span><span class="n">df_tot</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;DecayTree&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">save_BDT</span><span class="p">:</span>
        <span class="n">dump_pickle</span><span class="p">(</span><span class="n">bdt</span><span class="p">,</span> <span class="n">string</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s1">&#39;bdt&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">))</span></div>

</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Anthony Correia.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>